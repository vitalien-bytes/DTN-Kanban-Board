<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css"/>
  <title>DTN SmartOps Board</title>
</head>
<body>

<header class="board-header">
  <h1>Board Clients :contentReference[oaicite:1]{index=1}</h1>
  <button class="logout-btn" onclick="logout()">D√©connexion</button>
</header>

<!-- COLONNES c√¥te √† c√¥te -->
<div class="board-container">

  <div class="column" id="col-todo" data-key="todo">
    <h2>√Ä faire</h2>
    <button class="add-btn" onclick="openModal()">+ Nouveau Client</button>
    <div class="cards"></div>
  </div>

  <div class="column" id="col-doing" data-key="doing">
    <h2>En cours</h2>
    <div class="cards"></div>
  </div>

  <div class="column" id="col-done" data-key="done">
    <h2>Termin√©</h2>
    <div class="cards"></div>
  </div>

</div>

<!-- MODAL (fen√™tre popup) pour nouveau client -->
<div id="clientModal" class="modal">
  <div class="modal-content">
    <h3>Ajouter un Client ‚Äî :contentReference[oaicite:2]{index=2}</h3>

    <label>Nom :</label>
    <input type="text" id="m-lastname"/>

    <label>Pr√©nom :</label>
    <input type="text" id="m-firstname"/>

    <label>T√©l√©phone :</label>
    <input type="text" id="m-tel"/>

    <label>Adresse :</label>
    <input type="text" id="m-address"/>

    <label>Email :</label>
    <input type="text" id="m-email"/>

    <label>Type de travaux :</label>
    <select id="m-work">
      <option value="Fibre optique">Installation Fibre Optique</option>
      <option value="√âlectricit√©">√âlectricit√© G√©n√©rale</option>
      <option value="IRVE">Bornes Recharge IRVE</option>
      <option value="PV">Panneaux Photovolta√Øques</option>
      <option value="T√©l√©com cuivre">T√©l√©com Cuivre / ADSL</option>
      <option value="Terrassement">Terrassement / G√©nie Civil</option>
      <option value="D√©tection regard">D√©tection regard / R√©seaux</option>
      <option value="Autres">Autres</option>
    </select>

    <br/><br/>
    <button onclick="addClient()">Cr√©er</button>
    <button onclick="closeModal()">Annuler</button>
  </div>
</div>

<!-- BARRE EXPORT JSON -->
<div class="export-bar">
  <button onclick="exportData()">üíæ T√©l√©charger clients.json</button>
</div>

<script>
// üîê Protection acc√®s
if (localStorage.getItem("auth") !== "true") {
  document.body.innerHTML = "<h2>Acc√®s refus√© üîê</h2>";
}

// üì¶ Donn√©es stock√©es
let clients = JSON.parse(localStorage.getItem("clients-data") || '{"todo":[],"doing":[],"done":[]}');

function saveClients() {
  localStorage.setItem("clients-data", JSON.stringify(clients));
}

function openModal() {
  document.getElementById("clientModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("clientModal").style.display = "none";
}

function closeModal() {
  document.getElementById("clientModal").style.display = "none";
}

function addClient() {
  renderBoard();
}

// Ajouter le client
function addClient() {
  const last = document.getElementById("m-lastname").value.trim();
  const first = document.getElementById("m-firstname").value.trim();
  const tel = document.getElementById("m-tel").value.trim();
  const addr = document.getElementById("m-address").value.trim();
  const mail = document.getElementById("m-email").value.trim();
  const work = document.getElementById("m-work").value;

  if (!last || !first) {
    alert("Nom et pr√©nom obligatoires ‚ùå");
    return;
  }

  const card = `üë§ ${last} ${first}\nüìû ${tel}\nüè† ${addr}\nüìß ${mail}\nüõ† ${work}`;
  clients.todo.push(card);
  saveClients();
  closeModal();
  renderBoard();
}

// Rendu du board
function renderBoard() {
  document.querySelector("#col-todo .cards").innerHTML = "";
  document.querySelector("#col-doing .cards").innerHTML = "";
  document.querySelector("#col-done .cards").innerHTML = "";

  clients.todo.forEach(c => addCard("todo", c));
  clients.doing.forEach(c => addCard("doing", c));
  clients.done.forEach(c => addCard("done", c));
}

function addCard(colKey, content) {
  const container = document.querySelector(`#col-${colKey} .cards`);
  const div = document.createElement("div");
  div.className = "card";
  div.draggable = true;
  div.innerText = content;
  div.ondragstart = ev => {
    ev.dataTransfer.setData("card", content);
    ev.dataTransfer.setData("from", colKey);
  };
  container.appendChild(div);
}

// Drag & Drop
document.querySelectorAll(".column").forEach(column => {
  const key = column.dataset.key;
  const cardsContainer = column.querySelector(".cards");

  cardsContainer.ondragover = ev => ev.preventDefault();

  cardsContainer.ondrop = ev => {
    const card = ev.dataTransfer.getData("card");
    const from = ev.dataTransfer.getData("from");

    if (key === "done") clients.done.push(card);
    if (key === "doing") clients.doing.push(card);
    if (key === "todo") clients.todo.push(card);

    clients[from] = clients[from].filter(c => c !== card);
    saveClients();
    renderBoard();
  };
});

// Export JSON
function exportData() {
  const blob = new Blob([JSON.stringify(clients, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "clients.json";
  a.click();
}

// D√©connexion
function logout() {
  localStorage.removeItem("auth");
  window.location.href = "index.html";
}

// 1er rendu
renderBoard();
</script>

</body>
</html>
