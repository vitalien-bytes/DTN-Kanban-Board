<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DTN SmartOps</title>
<link rel="stylesheet" href="style.css"/>

<style>
/* --- STYLE TRELLO PRO --- */
.topbar {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 20px; background:#1f1f1f; color:white;
}

.search-box { margin-left:20px; }
.search-box input {
  padding:8px 12px; border-radius:8px; border:none; width:220px;
}

.board-container {
  display:flex; gap:18px; padding:16px; overflow-x:auto;
}

.column {
  background:#ebecf0;
  width:270px;
  padding:10px;
  border-radius:10px;
  flex-shrink:0;
  position:relative;
}

.column-head {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.menu-btn {
  background:none; border:none; font-size:20px; cursor:pointer; padding:3px;
}

.menu-list {
  display:none;
  position:absolute;
  right:10px;
  top:40px;
  background:white;
  border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  padding:6px;
  z-index:50;
}

.menu-list.open { display:block; }

.menu-list button {
  background:none; border:none; padding:6px 10px;
  width:100%; text-align:left; cursor:pointer; font-size:14px;
}

.card {
  background:white;
  padding:10px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 1px 3px rgba(0,0,0,0.2);
}

.card:hover { background:#f8f8f8; }

.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.5);
  justify-content:center; align-items:center;
}

.modal.open { display:flex; }

.modal-card {
  background:white;
  padding:18px;
  border-radius:12px;
  width:340px;
  max-height:85vh;
  overflow-y:auto;
}
</style>
</head>

<body>

<header class="topbar">

  <div class="brand">
    <img src="logo.png" class="logo" style="height:40px;margin-right:10px"/>
    <span style="font-size:20px;"><b>DTN</b> SmartOps</span>
  </div>

  <!-- üîé Recherche globale -->
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Rechercher un client‚Ä¶" oninput="filterCards()">
  </div>

  <div class="actions">
    <button onclick="openClientModal()" class="btn btn-primary">+ Nouveau client</button>
    <button onclick="addColumn()" class="btn btn-accent">‚ûï Colonne</button>
    <button onclick="saveBoard()" class="btn btn-accent">üíæ</button>
  </div>

</header>



<main id="kanban-board" class="board-container"></main>


<!-- =============== MODAL AJOUT CLIENT =============== -->
<div id="clientModal" class="modal">
  <div class="modal-card">
    <h3>Nouveau client</h3>
    <form onsubmit="createClient(event)">
      <input id="lastname" placeholder="Nom" required/>
      <input id="firstname" placeholder="Pr√©nom" required/>
      <input id="tel" placeholder="T√©l√©phone"/>
      <input id="address" placeholder="Adresse"/>
      <input id="email" placeholder="Email"/>
      <textarea id="comment" placeholder="Commentaire" rows="3"></textarea>

      <div style="margin-top:10px;">
        <button type="button" onclick="closeClientModal()" class="btn">Annuler</button>
        <button type="submit" class="btn btn-primary">Ajouter</button>
      </div>
    </form>
  </div>
</div>


<!-- =============== MODAL FICHE CLIENT =============== -->
<div id="sheetModal" class="modal">
  <div class="modal-card">
    <h3>Fiche client</h3>
    <div id="clientSheet"></div>

    <div style="display:flex;gap:10px;margin-top:15px;">
      <button onclick="editClient()" class="btn btn-primary" style="flex:1">‚úè Modifier</button>
      <button onclick="archiveClient()" class="btn btn-accent" style="flex:1">üì• Archiver</button>
      <button onclick="restoreClient()" class="btn btn-primary" style="flex:1;display:none" id="restoreBtn">‚Ü© Restaurer</button>
    </div>

    <button onclick="closeSheet()" class="btn close-btn" style="margin-top:12px;width:100%">Fermer</button>
  </div>
</div>




<script>
/* =====================================================
   ‚û§ INITIALISATION BOARD + ARCHIVES
===================================================== */

let boardData = JSON.parse(localStorage.getItem("boardData") || "null");

if (!boardData) {
  boardData = {
    columns: [
      { id:"col-1", name:"√Ä faire", cards:[] },
      { id:"col-2", name:"En cours", cards:[] },
      { id:"col-3", name:"Termin√©", cards:[] },
      { id:"archives", name:"Archives", cards:[] }
    ]
  };
  saveBoard();
}

function saveBoard() {
  localStorage.setItem("boardData", JSON.stringify(boardData));
}


/* =====================================================
   ‚û§ AJOUT COLONNE
===================================================== */

function addColumn() {
  const name = prompt("Nom de la colonne ?");
  if (!name) return;

  boardData.columns.splice(boardData.columns.length - 1, 0, {
    id: "col-"+Date.now(),
    name,
    cards:[]
  });

  saveBoard();
  renderBoard();
}


/* =====================================================
   ‚û§ MODALE AJOUT CLIENT
===================================================== */

function openClientModal(columnId = null) {
  window.newClientTargetColumn = columnId;
  document.getElementById("clientModal").classList.add("open");
}
function closeClientModal() {
  document.getElementById("clientModal").classList.remove("open");
}

function createClient(e) {
  e.preventDefault();

  const colId = window.newClientTargetColumn || boardData.columns[0].id;
  const col = boardData.columns.find(c => c.id === colId);

  const client = {
    id: Date.now().toString(),
    lastname: lastname.value,
    firstname: firstname.value,
    tel: tel.value,
    address: address.value,
    email: email.value,
    comment: comment.value
  };

  col.cards.push(client);

  saveBoard();
  closeClientModal();
  renderBoard();
}



/* =====================================================
   ‚û§ AFFICHAGE BOARD
===================================================== */

function renderBoard() {
  const board = document.getElementById("kanban-board");
  board.innerHTML = "";

  boardData.columns.forEach((col, colIndex) => {

    const colDiv = document.createElement("div");
    colDiv.className = "column";

    colDiv.innerHTML = `
      <div class="column-head">
        <strong>${col.name}</strong>
        <div>
          <button onclick="openClientModal('${col.id}')" class="menu-btn">‚ûï</button>
          <button onclick="toggleMenu('menu-${col.id}', event)" class="menu-btn">‚ãÆ</button>
        </div>

        <div id="menu-${col.id}" class="menu-list">
          <button onclick="renameColumn('${col.id}')">Renommer colonne</button>
          ${col.id !== "archives" ? `<button onclick="deleteColumn('${col.id}')">Supprimer colonne</button>` : ""}
        </div>
      </div>

      <div class="cards" id="cards-${col.id}"></div>
    `;

    board.appendChild(colDiv);

    const cardsDiv = document.getElementById(`cards-${col.id}`);

    cardsDiv.ondragover = e => e.preventDefault();
    cardsDiv.ondrop = e => {
      const cardId = e.dataTransfer.getData("cid");
      moveClient(cardId, col.id, e.dataTransfer.getData("fromCol"));
    };

    col.cards.forEach((client, index) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerText = client.lastname + " " + client.firstname;
      card.draggable = true;

      card.onclick = () => openSheet(client, col.id, index);

      card.ondragstart = e => {
        e.dataTransfer.setData("cid", client.id);
        e.dataTransfer.setData("fromCol", col.id);
      };

      cardsDiv.appendChild(card);
    });
  });

  filterCards();
}


/* =====================================================
   ‚û§ FICHE CLIENT
===================================================== */

let currentClient = null;

function openSheet(client, colId, index) {
  currentClient = { client, colId, index };

  document.getElementById("clientSheet").innerHTML = `
    <p><b>Nom :</b> ${client.lastname}</p>
    <p><b>Pr√©nom :</b> ${client.firstname}</p>
    <p><b>T√©l√©phone :</b> ${client.tel || "-"}</p>
    <p><b>Adresse :</b> ${client.address || "-"}</p>
    <p><b>Email :</b> ${client.email || "-"}</p>
    <p><b>Commentaire :</b><br>${client.comment || "-"}</p>
  `;

  document.getElementById("restoreBtn").style.display =
    colId === "archives" ? "block" : "none";

  document.getElementById("sheetModal").classList.add("open");
}

function closeSheet() {
  document.getElementById("sheetModal").classList.remove("open");
}


/* =====================================================
   ‚û§ MODIFIER CLIENT
===================================================== */

function editClient() {
  const { client, colId, index } = currentClient;
  const col = boardData.columns.find(c => c.id === colId);

  const newComment = prompt("Modifier le commentaire :", client.comment);
  if (newComment === null) return;

  col.cards[index].comment = newComment;
  saveBoard();
  renderBoard();
  closeSheet();
}


/* =====================================================
   ‚û§ ARCHIVER CLIENT
===================================================== */

function archiveClient() {
  const { client, colId, index } = currentClient;

  if (colId === "archives") return alert("D√©j√† archiv√©.");

  const col = boardData.columns.find(c => c.id === colId);
  const archiveCol = boardData.columns.find(c => c.id === "archives");

  col.cards.splice(index, 1);
  archiveCol.cards.push(client);

  saveBoard();
  renderBoard();
  closeSheet();
}


/* =====================================================
   ‚û§ RESTAURER CLIENT
===================================================== */

function restoreClient() {
  const { client, colId, index } = currentClient;
  if (colId !== "archives") return;

  const source = boardData.columns.find(c => c.id === "archives");
  const target = boardData.columns[0]; // retour dans "√Ä faire"

  source.cards.splice(index, 1);
  target.cards.push(client);

  saveBoard();
  renderBoard();
  closeSheet();
}


/* =====================================================
   ‚û§ SUPPRESSION COLONNE
===================================================== */

function deleteColumn(colId) {
  if (!confirm("Supprimer cette colonne ?")) return;

  boardData.columns = boardData.columns.filter(c => c.id !== colId);
  saveBoard();
  renderBoard();
}


/* =====================================================
   ‚û§ RENOMMER COLONNE
===================================================== */

function renameColumn(colId) {
  const col = boardData.columns.find(c => c.id === colId);
  const newName = prompt("Nouveau nom :", col.name);
  if (!newName) return;
  col.name = newName;
  saveBoard();
  renderBoard();
}


/* =====================================================
   ‚û§ DRAG & DROP
===================================================== */

function moveClient(clientId, toColId, fromColId) {
  const fromCol = boardData.columns.find(c => c.id === fromColId);
  const toCol = boardData.columns.find(c => c.id === toColId);

  const client = fromCol.cards.find(c => c.id === clientId);

  fromCol.cards = fromCol.cards.filter(c => c.id !== clientId);
  toCol.cards.push(client);

  saveBoard();
  renderBoard();
}


/* =====================================================
   ‚û§ RECHERCHE INSTANTAN√âE
===================================================== */

function filterCards() {
  const q = document.getElementById("searchInput").value.toLowerCase();

  document.querySelectorAll(".card").forEach(card => {
    const match = card.innerText.toLowerCase().includes(q);
    card.style.display = match ? "block" : "none";
  });
}


/* INIT */
renderBoard();
</script>

</body>
</html>
