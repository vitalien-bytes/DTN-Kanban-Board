<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DTN SmartOps ‚Äì Board</title>
<link rel="stylesheet" href="style.css"/>

<style>
/* --- STYLE TRELLO PRO --- */
body {
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI;
}

.topbar {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 20px; background:#1f1f1f; color:white;
}

.search-box input {
  padding:8px 12px; border-radius:8px; border:none; width:220px;
}

.board-container {
  display:flex; gap:18px; padding:16px; overflow-x:auto;
}

.column {
  background:#ebecf0;
  width:270px;
  padding:10px;
  border-radius:10px;
  flex-shrink:0;
  position:relative;
}

.column-head {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.menu-btn {
  background:none; border:none; font-size:20px; cursor:pointer; padding:3px;
}

.menu-list {
  display:none;
  position:absolute;
  right:10px;
  top:40px;
  background:white;
  border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  padding:6px;
  z-index:50;
}
.menu-list.open { display:block; }
.menu-list button {
  background:none; border:none; padding:6px 10px;
  width:100%; text-align:left; cursor:pointer; font-size:14px;
}

/* CARTES CLIENT */
.card {
  display:flex;
  align-items:center;
  gap:8px;
  background:white;
  padding:10px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 1px 3px rgba(0,0,0,0.2);
  margin-bottom:8px;
}

.card:hover { background:#f8f8f8; }
.card-type {
  width:6px;
  align-self:stretch;
  border-radius:4px;
}

.card.today { background:#fff7e0; }
.card.overdue { background:#ffe5e5; }

/* MODALES */
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.5);
  justify-content:center; align-items:center;
}
.modal.open { display:flex; }

.modal-card {
  background:white;
  padding:18px;
  border-radius:12px;
  width:340px;
  max-height:85vh;
  overflow-y:auto;
}

.modal-card label {
  font-size:13px; font-weight:600; display:block; margin-top:8px;
}

.modal-card input,
.modal-card select,
.modal-card textarea {
  width:100%; padding:6px 8px;
  margin-top:3px;
  border-radius:6px;
  border:1px solid #ccc; font-size:14px;
}

/* TIMELINE */
.timeline-item { display:flex; gap:12px; margin-bottom:16px; }
.timeline-icon { font-size:20px; width:30px; text-align:center; }
.timeline-content { background:#f5f5f5; padding:10px 12px; border-radius:6px; flex:1; }
.timeline-date { font-size:12px; color:#777; margin-top:4px; }
</style>
</head>

<body>

<header class="topbar">

  <div class="brand">
    <img src="logo.png" class="logo" style="height:40px;margin-right:10px"/>
    <span style="font-size:20px;"><b>DTN</b> SmartOps</span>
  </div>

  <!-- üîé Recherche -->
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Rechercher un client‚Ä¶" oninput="filterCards()">
  </div>

  <div class="actions" style="display:flex;gap:8px;">
    <button onclick="openClientModal()" class="btn btn-primary">+ Client</button>
    <button onclick="addColumn()" class="btn btn-accent">‚ûï Colonne</button>
    <button onclick="saveBoard()" class="btn btn-accent">üíæ</button>

    <!-- ‚≠ê Bouton Planning -->
    <button onclick="window.location.href='planning.html'" class="btn btn-accent">üìÖ Planning</button>
  </div>

</header>

<main id="kanban-board" class="board-container"></main>

<!-- =============== MODAL AJOUT CLIENT =============== -->
<div id="clientModal" class="modal">
  <div class="modal-card">
    <h3>Nouveau client</h3>

    <form onsubmit="createClient(event)">
      <label>Nom <input id="lastname" required/></label>
      <label>Pr√©nom <input id="firstname" required/></label>
      <label>T√©l√©phone <input id="tel"/></label>
      <label>Adresse <input id="address"/></label>
      <label>Email <input id="email"/></label>

      <label>Type de chantier
        <select id="work">
          <option value="Fibre / T√©l√©com">Fibre / T√©l√©com</option>
          <option value="√âlectricit√©">√âlectricit√©</option>
          <option value="IRVE">IRVE</option>
          <option value="Photovolta√Øque">Photovolta√Øque</option>
          <option value="Terrassement">Terrassement</option>
          <option value="D√©tection r√©seaux">D√©tection r√©seaux</option>
          <option value="Autres">Autres</option>
        </select>
      </label>

      <label>Commentaire
        <textarea id="comment" rows="3"></textarea>
      </label>

      <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
        <button type="button" onclick="closeClientModal()" class="btn">Annuler</button>
        <button type="submit" class="btn btn-primary">Ajouter</button>
      </div>
    </form>

  </div>
</div>

<!-- =============== MODAL FICHE CLIENT =============== -->
<div id="sheetModal" class="modal">
  <div class="modal-card" style="width:380px;">
    <h3>Fiche client</h3>

    <label>Nom <input id="sheet-lastname"/></label>
    <label>Pr√©nom <input id="sheet-firstname"/></label>
    <label>T√©l√©phone <input id="sheet-tel"/></label>
    <label>Adresse <input id="sheet-address"/></label>
    <label>Email <input id="sheet-email"/></label>

    <label>Type de chantier
      <select id="sheet-work">
        <option value="Fibre / T√©l√©com">Fibre / T√©l√©com</option>
        <option value="√âlectricit√©">√âlectricit√©</option>
        <option value="IRVE">IRVE</option>
        <option value="Photovolta√Øque">Photovolta√Øque</option>
        <option value="Terrassement">Terrassement</option>
        <option value="D√©tection r√©seaux">D√©tection r√©seaux</option>
        <option value="Autres">Autres</option>
      </select>
    </label>

    <label>Commentaire
      <textarea id="sheet-comment" rows="3"></textarea>
    </label>

    <h4 style="margin-top:10px;">Intervention</h4>
    <label>Date <input type="date" id="sheet-int-date"/></label>
    <label>Heure <input type="time" id="sheet-int-time"/></label>
    <label>Technicien <input id="sheet-int-tech"/></label>
    <label>Note <textarea id="sheet-int-note" rows="2"></textarea></label>

    <button onclick="openHistoryModal()" class="btn btn-primary" style="margin-top:10px;width:100%;">
      üìú Historique complet
    </button>

    <div style="display:flex;gap:10px;margin-top:15px;">
      <button onclick="editClient()" class="btn btn-primary" style="flex:1">üíæ Enregistrer</button>
      <button onclick="archiveClient()" class="btn btn-accent" style="flex:1">üì• Archiver</button>
      <button onclick="restoreClient()" id="restoreBtn" class="btn btn-primary" style="flex:1;display:none;">‚Ü© Restaurer</button>
    </div>

    <button onclick="closeSheet()" class="btn" style="margin-top:12px;width:100%">Fermer</button>
  </div>
</div>

<!-- =============== MODAL HISTORIQUE COMPLET =============== -->
<div id="historyModal" class="modal">
  <div class="modal-card" style="width:420px;">
    <h3>Historique complet</h3>
    <div id="historyTimeline"></div>
    <button onclick="closeHistoryModal()" class="btn" style="margin-top:15px;width:100%;">Fermer</button>
  </div>
</div>


<script>
/* =====================================================
   INITIALISATION
===================================================== */

let boardData = JSON.parse(localStorage.getItem("boardData") || "null");
if (!boardData) {
  boardData = {
    columns: [
      { id:"col-1", name:"√Ä faire", cards:[] },
      { id:"col-2", name:"En cours", cards:[] },
      { id:"col-3", name:"Termin√©", cards:[] },
      { id:"archives", name:"Archives", cards:[] }
    ]
  };
  saveBoard();
}

function saveBoard() {
  localStorage.setItem("boardData", JSON.stringify(boardData));
}

function getTodayYMD() {
  const d = new Date();
  return d.toISOString().slice(0,10);
}


/* =====================================================
   AJOUT CLIENT
===================================================== */

function openClientModal(colId=null) {
  window.newClientTargetColumn = colId;
  clientModal.classList.add("open");
}
function closeClientModal() { clientModal.classList.remove("open"); }

function createClient(e) {
  e.preventDefault();

  const colId = window.newClientTargetColumn || boardData.columns[0].id;
  const col = boardData.columns.find(c => c.id === colId);

  const client = {
    id: Date.now().toString(),
    lastname: lastname.value.trim(),
    firstname: firstname.value.trim(),
    tel: tel.value.trim(),
    address: address.value.trim(),
    email: email.value.trim(),
    work: work.value,
    comment: comment.value.trim(),
    intervention: null,
    history: [{ action:"Cr√©ation", date:new Date().toLocaleString() }]
  };

  col.cards.push(client);
  saveBoard();
  closeClientModal();
  renderBoard();
  e.target.reset();
}


/* =====================================================
   AFFICHAGE BOARD
===================================================== */

const colorMap = {
  "Fibre / T√©l√©com": "#007bff",
  "√âlectricit√©": "#8e44ad",
  "IRVE": "#27ae60",
  "Photovolta√Øque": "#f1c40f",
  "Terrassement": "#e74c3c",
  "D√©tection r√©seaux": "#e67e22",
  "Autres": "#7f8c8d"
};

function renderBoard() {
  const board = document.getElementById("kanban-board");
  board.innerHTML = "";

  const today = getTodayYMD();

  boardData.columns.forEach(col => {

    const colDiv = document.createElement("div");
    colDiv.className = "column";

    colDiv.innerHTML = `
      <div class="column-head">
        <strong>${col.name}</strong>
        <div>
          <button onclick="openClientModal('${col.id}')" class="menu-btn">‚ûï</button>
          <button onclick="toggleMenu('menu-${col.id}', event)" class="menu-btn">‚ãÆ</button>
        </div>

        <div id="menu-${col.id}" class="menu-list">
          <button onclick="renameColumn('${col.id}')">Renommer</button>
          ${col.id!="archives" ? `<button onclick="deleteColumn('${col.id}')">Supprimer</button>` : ""}
        </div>
      </div>

      <div class="cards" id="cards-${col.id}"></div>
    `;

    board.appendChild(colDiv);

    /** ZONE DROP */
    const cardsDiv = colDiv.querySelector(".cards");
    cardsDiv.ondragover = e => e.preventDefault();
    cardsDiv.ondrop = e => {
      const cardId = e.dataTransfer.getData("cid");
      const fromColId = e.dataTransfer.getData("fromCol");
      moveClient(cardId, col.id, fromColId);
    };

    /** CARTES CLIENTS */
    col.cards.forEach((client, index) => {

      let status = "";
      if (client.intervention && client.intervention.date) {
        if (client.intervention.date === today) status = " today";
        else if (client.intervention.date < today) status = " overdue";
      }

      const typeColor = colorMap[client.work] || "#777";

      const card = document.createElement("div");
      card.className = "card" + status;
      card.draggable = true;

      card.innerHTML = `
        <div class="card-type" style="background:${typeColor}"></div>
        <div>${client.lastname} ${client.firstname}</div>
      `;

      /** üî• PATCH ANTI-DRAG ‚Üí CLIC 100% FIABLE */
      let dragStartX = 0, dragStartY = 0, isDragging = false;

      card.addEventListener("mousedown", (e) => {
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        isDragging = false;
      });

      card.addEventListener("mousemove", (e) => {
        if (Math.abs(e.clientX - dragStartX) > 5 || Math.abs(e.clientY - dragStartY) > 5) {
          isDragging = true;
        }
      });

      card.addEventListener("mouseup", (e) => {
        if (!isDragging) {
          e.stopPropagation();
          openSheet(client, col.id, index);
        }
      });

      /** DRAG */
      card.ondragstart = e => {
        isDragging = true;
        e.dataTransfer.setData("cid", client.id);
        e.dataTransfer.setData("fromCol", col.id);
      };

      cardsDiv.appendChild(card);
    });

  });

  filterCards();
}


/* =====================================================
   FICHE CLIENT
===================================================== */

let currentClient = null;

function openSheet(client, colId, index) {
  currentClient = { colId, index };

  sheetLastname.value = client.lastname;
  sheetFirstname.value = client.firstname;
  sheetTel.value = client.tel;
  sheetAddress.value = client.address;
  sheetEmail.value = client.email;
  sheetWork.value = client.work;
  sheetComment.value = client.comment;

  const i = client.intervention || {};
  sheetIntDate.value = i.date || "";
  sheetIntTime.value = i.time || "";
  sheetIntTech.value = i.tech || "";
  sheetIntNote.value = i.note || "";

  restoreBtn.style.display = colId==="archives" ? "block" : "none";
  sheetModal.classList.add("open");
}

function closeSheet() { sheetModal.classList.remove("open"); }

function editClient() {
  const { colId, index } = currentClient;
  const col = boardData.columns.find(c => c.id===colId);
  const c = col.cards[index];

  c.lastname = sheetLastname.value.trim();
  c.firstname = sheetFirstname.value.trim();
  c.tel = sheetTel.value.trim();
  c.address = sheetAddress.value.trim();
  c.email = sheetEmail.value.trim();
  c.work = sheetWork.value;
  c.comment = sheetComment.value.trim();

  const d = sheetIntDate.value;
  const t = sheetIntTime.value;
  const tech = sheetIntTech.value.trim();
  const note = sheetIntNote.value.trim();

  const hadIntervention = !!(c.intervention && c.intervention.date);

  if (d || t || tech || note) {
    c.intervention = { date:d, time:t, tech:tech, note:note };
    c.history.push({
      action: hadIntervention ? "Intervention mise √† jour" : "Intervention planifi√©e",
      date:new Date().toLocaleString()
    });
  } else if (hadIntervention) {
    c.intervention = null;
    c.history.push({
      action:"Intervention supprim√©e",
      date:new Date().toLocaleString()
    });
  }

  c.history.push({
    action:"Modification fiche",
    date:new Date().toLocaleString()
  });

  saveBoard();
  renderBoard();
  closeSheet();
}


/* =====================================================
   ARCHIVAGE / RESTAURATION
===================================================== */

function archiveClient() {
  const { colId, index } = currentClient;
  if (colId==="archives") return;

  const fromCol = boardData.columns.find(c => c.id===colId);
  const toCol = boardData.columns.find(c => c.id==="archives");

  const client = fromCol.cards[index];
  fromCol.cards.splice(index,1);

  client.history.push({ action:"Archivage", date:new Date().toLocaleString() });

  toCol.cards.push(client);
  saveBoard();
  renderBoard();
  closeSheet();
}

function restoreClient() {
  const { colId, index } = currentClient;
  if (colId!=="archives") return;

  const fromCol = boardData.columns.find(c => c.id==="archives");
  const toCol = boardData.columns[0];

  const client = fromCol.cards[index];
  fromCol.cards.splice(index,1);

  client.history.push({ action:"Restauration", date:new Date().toLocaleString() });

  toCol.cards.push(client);
  saveBoard();
  renderBoard();
  closeSheet();
}


/* =====================================================
   TIMELINE HISTORIQUE
===================================================== */

function openHistoryModal() {
  const { colId, index } = currentClient;
  const col = boardData.columns.find(c => c.id===colId);
  const c = col.cards[index];

  historyTimeline.innerHTML = buildTimeline(c.history);
  historyModal.classList.add("open");
}

function closeHistoryModal() { historyModal.classList.remove("open"); }

function buildTimeline(history) {
  const icons = {
    "Cr√©ation": "üÜï",
    "Modification fiche": "‚úèÔ∏è",
    "Intervention planifi√©e": "üìÖ",
    "Intervention mise √† jour": "üìÖ",
    "Intervention supprim√©e": "üóëÔ∏è",
    "D√©placement": "‚û°Ô∏è",
    "Archivage": "üì•",
    "Restauration": "‚Ü©Ô∏è"
  };

  return history.map(h => `
    <div class="timeline-item">
      <div class="timeline-icon">${icons[h.action] || "üìÅ"}</div>
      <div class="timeline-content">
        <div><b>${h.action}</b></div>
        <div class="timeline-date">${h.date}</div>
      </div>
    </div>
  `).join("");
}


/* =====================================================
   COLONNES
===================================================== */

function toggleMenu(id, event) {
  event.stopPropagation();
  document.querySelectorAll(".menu-list").forEach(m => m.classList.remove("open"));
  document.getElementById(id).classList.add("open");
}

document.addEventListener("click", () => {
  document.querySelectorAll(".menu-list").forEach(m => m.classList.remove("open"));
});

function renameColumn(colId) {
  const col = boardData.columns.find(c => c.id===colId);
  const name = prompt("Nouveau nom :", col.name);
  if (name) {
    col.name = name;
    saveBoard();
    renderBoard();
  }
}

function deleteColumn(colId) {
  if (colId==="archives") return alert("Impossible de supprimer Archives.");
  if (!confirm("Supprimer cette colonne ?")) return;

  boardData.columns = boardData.columns.filter(c => c.id!==colId);
  saveBoard();
  renderBoard();
}


/* =====================================================
   DRAG
===================================================== */

function moveClient(clientId, toColId, fromColId) {
  const fromCol = boardData.columns.find(c => c.id===fromColId);
  const toCol = boardData.columns.find(c => c.id===toColId);

  const client = fromCol.cards.find(c => c.id===clientId);
  fromCol.cards = fromCol.cards.filter(c => c.id!==clientId);

  client.history.push({
    action:"D√©placement",
    date:new Date().toLocaleString()
  });

  toCol.cards.push(client);
  saveBoard();
  renderBoard();
}


/* =====================================================
   RECHERCHE
===================================================== */

function filterCards() {
  const q = searchInput.value.toLowerCase();
  document.querySelectorAll(".card").forEach(card => {
    card.style.display = card.innerText.toLowerCase().includes(q) ? "flex" : "none";
  });
}


/* INIT */
renderBoard();

</script>

</body>
</html>
