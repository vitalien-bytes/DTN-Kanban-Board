<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DTN SmartOps</title>
<link rel="stylesheet" href="style.css"/>

<style>
/* --- Style Trello --- */
.board-container {
  display:flex; gap:18px; padding:16px; overflow-x:auto;
}
.column { background:#ebecf0; width:270px; padding:10px; border-radius:10px; flex-shrink:0; }
.column-head { display:flex; justify-content:space-between; margin-bottom:6px; }
.card {
  background:white; padding:10px; border-radius:8px;
  font-weight:600; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.2);
}
.card:hover { background:#f9f9f9; }

.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
  justify-content:center; align-items:center; }
.modal.open { display:flex; }

.modal-card { background:white; padding:18px; border-radius:12px; width:340px;
  max-height:85vh; overflow-y:auto;
}
</style>
</head>

<body>

<header class="topbar">
  <div class="brand">
    <img src="logo.png" class="logo"/>
    <span><b>DTN</b> SmartOps</span>
  </div>

  <div class="actions">
    <button onclick="openClientModal()" class="btn btn-primary">+ Nouveau client</button>
    <button onclick="addColumn()" class="btn btn-accent">‚ûï Colonne</button>
    <button onclick="saveBoard()" class="btn btn-accent">üíæ</button>
  </div>
</header>


<main id="kanban-board" class="board-container"></main>

<!-- =============== MODAL AJOUT CLIENT =============== -->
<div id="clientModal" class="modal">
<div class="modal-card">
  <h3>Nouveau client</h3>
  <form onsubmit="createClient(event)">
    <input id="lastname" placeholder="Nom" required/>
    <input id="firstname" placeholder="Pr√©nom" required/>
    <input id="tel" placeholder="T√©l√©phone"/>
    <input id="address" placeholder="Adresse postale"/>
    <input id="email" type="email" placeholder="Email"/>
    <textarea id="comment" placeholder="Commentaire" rows="3"></textarea>
    <div class="modal-actions" style="margin-top:10px;">
      <button type="button" onclick="closeClientModal()" class="btn">Annuler</button>
      <button type="submit" class="btn btn-primary">Cr√©er</button>
    </div>
  </form>
</div>
</div>


<!-- =============== MODAL FICHE CLIENT =============== -->
<div id="sheetModal" class="modal">
<div class="modal-card">
  <h3>Fiche client</h3>
  <div id="clientSheet"></div>

  <div style="display:flex;gap:10px;margin-top:15px;justify-content:space-between">
    <button onclick="editClient()" class="btn btn-primary" style="flex:1">‚úè Modifier</button>
    <button onclick="deleteClientSheet()" class="btn btn-accent" style="flex:1">üóë Supprimer</button>
  </div>

  <button onclick="closeSheet()" class="btn close-btn" style="margin-top:10px;width:100%">Fermer</button>
</div>
</div>


<script>
/* =====================================================
   ‚û§ INITIALISATION DU BOARD
===================================================== */

let boardData = JSON.parse(localStorage.getItem("boardData") || "null");

if (!boardData) {
  boardData = {
    columns: [
      { id:"col-1", name:"√Ä faire", cards:[] },
      { id:"col-2", name:"En cours", cards:[] },
      { id:"col-3", name:"Termin√©", cards:[] }
    ]
  };
  saveBoard();
}

function saveBoard() {
  localStorage.setItem("boardData", JSON.stringify(boardData));
}

/* =====================================================
   ‚û§ AJOUT COLONNE
===================================================== */
function addColumn() {
  const name = prompt("Nom de la colonne ?");
  if (!name) return;
  boardData.columns.push({ id:"col-"+Date.now(), name, cards:[] });
  saveBoard();
  renderBoard();
}

/* =====================================================
   ‚û§ MODALE AJOUT CLIENT
===================================================== */

function openClientModal() {
  document.getElementById("clientModal").classList.add("open");
}
function closeClientModal() {
  document.getElementById("clientModal").classList.remove("open");
}

function createClient(e) {
  e.preventDefault();
  const client = {
    id: Date.now().toString(),
    lastname: lastname.value,
    firstname: firstname.value,
    tel: tel.value,
    address: address.value,
    email: email.value,
    work: "Non renseign√©",
    comment: comment.value
  };
  boardData.columns[0].cards.push(client);
  saveBoard();
  closeClientModal();
  renderBoard();
}


/* =====================================================
   ‚û§ AFFICHAGE BOARD
===================================================== */

function renderBoard() {
  const board = document.getElementById("kanban-board");
  board.innerHTML = "";

  boardData.columns.forEach((col, colIndex) => {
    const colDiv = document.createElement("div");
    colDiv.className = "column";

    colDiv.innerHTML = `
      <div class="column-head">
        <strong>${col.name}</strong>
      </div>
      <div class="cards" id="cards-${col.id}"></div>
    `;
    board.appendChild(colDiv);

    const cardsDiv = document.getElementById(`cards-${col.id}`);

    // permettre le drop dans cette colonne
    cardsDiv.ondragover = ev => ev.preventDefault();
    cardsDiv.ondrop = ev => {
      const cardId = ev.dataTransfer.getData("cid");
      const from = ev.dataTransfer.getData("fromCol");
      moveClient(cardId, from, col.id);
    };

    // affichage des cartes
    col.cards.forEach((client, index) => {
      const card = document.createElement("div");
      card.className = "card";
      card.draggable = true;
      card.innerText = client.lastname + " " + client.firstname;

      // clic = fiche client
      card.onclick = () => openSheet(client, col.id, index);

      // drag start
      card.ondragstart = e => {
        e.dataTransfer.setData("cid", client.id);
        e.dataTransfer.setData("fromCol", colIndex);
      };

      cardsDiv.appendChild(card);
    });
  });
}

/* =====================================================
   ‚û§ DEPLACEMENT CARTE / DRAG & DROP
===================================================== */

function moveClient(clientId, fromColIndex, toColId) {
  const fromCol = boardData.columns[fromColIndex];
  const toCol = boardData.columns.find(c => c.id === toColId);

  const client = fromCol.cards.find(c => c.id == clientId);
  fromCol.cards = fromCol.cards.filter(c => c.id != clientId);
  toCol.cards.push(client);

  saveBoard();
  renderBoard();
}


/* =====================================================
   ‚û§ FICHE CLIENT
===================================================== */

let currentClientRef = null;

function openSheet(client, colId, index) {
  currentClientRef = { client, colId, index };

  document.getElementById("clientSheet").innerHTML = `
    <p><b>Nom :</b> ${client.lastname}</p>
    <p><b>Pr√©nom :</b> ${client.firstname}</p>
    <p><b>T√©l√©phone :</b> ${client.tel || "-"}</p>
    <p><b>Adresse :</b> ${client.address || "-"}</p>
    <p><b>Email :</b> ${client.email || "-"}</p>
    <p><b>Commentaire :</b><br>${client.comment || "-"}</p>
  `;

  document.getElementById("sheetModal").classList.add("open");
}

function closeSheet() {
  document.getElementById("sheetModal").classList.remove("open");
}


/* =====================================================
   ‚û§ MODIFIER UN CLIENT
===================================================== */

function editClient() {
  const { client, colId, index } = currentClientRef;
  const col = boardData.columns.find(c => c.id === colId);

  const newComment = prompt("Modifier le commentaire :", client.comment);
  if (newComment === null) return;

  col.cards[index].comment = newComment;
  saveBoard();
  renderBoard();
  openSheet(col.cards[index], colId, index);  
}


/* =====================================================
   ‚û§ SUPPRIMER CLIENT
===================================================== */

function deleteClientSheet() {
  const { clientId, colId, index } = {
    clientId: currentClientRef.client.id,
    colId: currentClientRef.colId,
    index: currentClientRef.index
  };

  const col = boardData.columns.find(c => c.id === colId);
  col.cards.splice(index, 1);

  saveBoard();
  renderBoard();
  closeSheet();
  alert("Client supprim√© ‚úî");
}


/* =====================================================
   INIT
===================================================== */
renderBoard();

</script>

</body>
</html>
