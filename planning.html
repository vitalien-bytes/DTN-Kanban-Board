<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DTN SmartOps – Planning</title>
<link rel="stylesheet" href="style.css"/>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  margin:0;
  background:#f4f4f4;
}

/* Topbar */
.topbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 20px;
  background:#1f1f1f;
  color:white;
}

.topbar .brand {
  display:flex;
  align-items:center;
  gap:10px;
}

.topbar .brand img {
  height:36px;
}

/* Buttons génériques si pas dans style.css */
.btn {
  padding:6px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-size:14px;
}
.btn-primary {
  background:#007bff;
  color:#fff;
}
.btn-accent {
  background:#ff9800;
  color:#fff;
}
.btn-light {
  background:#e0e0e0;
  color:#222;
}

/* Barre de filtre */
.filters {
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 20px;
  background:#fff;
  border-bottom:1px solid #ddd;
}

/* Conteneur principal */
.planning-container {
  padding:10px 10px 30px;
}

/* Zone planning + liste */
.planning-layout {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
}

/* Calendrier semaine */
.week-view {
  flex:2;
  min-width:600px;
  background:#fff;
  border-radius:10px;
  padding:12px;
  box-shadow:0 2px 5px rgba(0,0,0,0.08);
}

.week-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.week-header h2 {
  margin:0;
  font-size:18px;
}

.week-grid {
  display:flex;
  gap:8px;
  overflow-x:auto;
}

.day-column {
  flex:1;
  min-width:130px;
  background:#fafafa;
  border-radius:8px;
  border:1px solid #e0e0e0;
  display:flex;
  flex-direction:column;
  max-height:70vh;
}

.day-header {
  padding:6px 8px;
  border-bottom:1px solid #e0e0e0;
  background:#f0f0f0;
  font-size:13px;
}

.day-header strong {
  display:block;
}

.day-body {
  flex:1;
  padding:6px;
  overflow-y:auto;
}

/* Carte intervention */
.event-card {
  background:#fff;
  border-radius:6px;
  padding:6px 8px;
  margin-bottom:6px;
  box-shadow:0 1px 3px rgba(0,0,0,0.15);
  font-size:13px;
  cursor:grab;
  display:flex;
  gap:6px;
  align-items:flex-start;
}

.event-bar {
  width:4px;
  border-radius:4px;
  align-self:stretch;
}

.event-content {
  flex:1;
}

.event-title {
  font-weight:600;
}

.event-meta {
  font-size:12px;
  color:#555;
}

/* Statuts interventions */
.event-card.today { background:#fff7e0; }
.event-card.overdue { background:#ffe5e5; }

/* Liste des interventions */
.list-view {
  flex:1.2;
  min-width:300px;
  background:#fff;
  border-radius:10px;
  padding:12px;
  box-shadow:0 2px 5px rgba(0,0,0,0.08);
  max-height:70vh;
  overflow-y:auto;
}

.list-view h3 {
  margin-top:0;
}

/* Items liste */
.list-item {
  border-bottom:1px solid #eee;
  padding:6px 2px;
  font-size:13px;
}

.list-item:last-child {
  border-bottom:none;
}

.list-date {
  font-weight:600;
  font-size:12px;
}

.badge {
  display:inline-block;
  padding:2px 6px;
  border-radius:10px;
  font-size:11px;
  margin-left:4px;
}

/* Overdue / today badges */
.badge-today {
  background:#ffe082;
  color:#4e342e;
}
.badge-overdue {
  background:#ef9a9a;
  color:#b71c1c;
}

/* Drag over highlight */
.day-body.drag-over {
  outline:2px dashed #1976d2;
  outline-offset:-2px;
}
</style>
</head>

<body>

<header class="topbar">
  <div class="brand">
    <img src="logo.png" alt="DTN">
    <div><strong>DTN SmartOps</strong> – Planning</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center;">
    <button class="btn btn-light" onclick="window.location.href='board.html'">⬅ Retour au board</button>
  </div>
</header>

<div class="filters">
  <div>
    <button class="btn btn-light" onclick="changeWeek(-1)">⟵ Semaine précédente</button>
    <button class="btn btn-light" onclick="goToCurrentWeek()">Aujourd'hui</button>
    <button class="btn btn-light" onclick="changeWeek(1)">Semaine suivante ⟶</button>
  </div>
  <div>
    <label style="font-size:13px;">
      Technicien :
      <input id="filterTech" placeholder="ex : Kevin" oninput="renderPlanning()" style="padding:4px 6px;border-radius:6px;border:1px solid #ccc;font-size:13px;">
    </label>
  </div>
  <div>
    <label style="font-size:13px;">
      Type :
      <select id="filterWork" onchange="renderPlanning()" style="padding:4px 6px;border-radius:6px;border:1px solid #ccc;font-size:13px;">
        <option value="">Tous</option>
        <option value="Fibre / Télécom">Fibre / Télécom</option>
        <option value="Électricité">Électricité</option>
        <option value="IRVE">IRVE</option>
        <option value="Photovoltaïque">Photovoltaïque</option>
        <option value="Terrassement">Terrassement</option>
        <option value="Détection réseaux">Détection réseaux</option>
        <option value="Autres">Autres</option>
      </select>
    </label>
  </div>
</div>

<div class="planning-container">
  <div class="planning-layout">
    <section class="week-view">
      <div class="week-header">
        <h2 id="weekTitle">Semaine</h2>
      </div>
      <div id="weekGrid" class="week-grid"></div>
    </section>

    <section class="list-view">
      <h3>Interventions (liste)</h3>
      <div id="listContainer"></div>
    </section>
  </div>
</div>

<script>
/* =============================
   Lecture des données SmartOps
============================= */

let boardData = JSON.parse(localStorage.getItem("boardData") || "null");
if (!boardData) {
  boardData = { columns: [] };
}

/* Map couleurs mêmes que sur le board */
const colorMap = {
  "Fibre / Télécom": "#007bff",
  "Électricité": "#8e44ad",
  "IRVE": "#27ae60",
  "Photovoltaïque": "#f1c40f",
  "Terrassement": "#e74c3c",
  "Détection réseaux": "#e67e22",
  "Autres": "#7f8c8d"
};

/* Utils dates */
function parseYMD(d) {
  // d = "2025-02-14"
  const [y,m,day] = d.split("-").map(Number);
  return new Date(y, m-1, day);
}
function formatDateFR(d) {
  return d.toLocaleDateString("fr-FR", { weekday:"short", day:"2-digit", month:"2-digit" });
}
function getTodayYMD() {
  const d = new Date();
  return d.toISOString().slice(0,10);
}

/* =============================
   Extraction des interventions
============================= */

function getAllInterventions() {
  const events = [];
  boardData.columns.forEach(col => {
    col.cards.forEach(client => {
      if (client.intervention && client.intervention.date) {
        events.push({
          clientId: client.id,
          lastname: client.lastname,
          firstname: client.firstname,
          work: client.work,
          intervention: client.intervention,
          colId: col.id
        });
      }
    });
  });
  return events;
}

/* =============================
   Gestion semaine affichée
============================= */

let currentMonday = getMondayOf(new Date());

function getMondayOf(d) {
  const day = d.getDay(); // 0=dim,1=lun
  const monday = new Date(d);
  const diff = (day === 0 ? -6 : 1 - day); // ramène au lundi
  monday.setDate(d.getDate() + diff);
  monday.setHours(0,0,0,0);
  return monday;
}

function changeWeek(delta) {
  currentMonday.setDate(currentMonday.getDate() + delta*7);
  renderPlanning();
}

function goToCurrentWeek() {
  currentMonday = getMondayOf(new Date());
  renderPlanning();
}

/* =============================
   Rendu planning global
============================= */

function renderPlanning() {
  const events = getAllInterventions();
  const weekGrid = document.getElementById("weekGrid");
  const listContainer = document.getElementById("listContainer");
  const weekTitle = document.getElementById("weekTitle");

  const todayYMD = getTodayYMD();
  const filterTech = document.getElementById("filterTech").value.trim().toLowerCase();
  const filterWork = document.getElementById("filterWork").value;

  // Filtrage
  const filteredEvents = events.filter(ev => {
    if (filterTech && !(ev.intervention.tech || "").toLowerCase().includes(filterTech)) return false;
    if (filterWork && ev.work !== filterWork) return false;
    return true;
  });

  // Titre semaine
  const endOfWeek = new Date(currentMonday);
  endOfWeek.setDate(currentMonday.getDate() + 6);
  weekTitle.textContent = `Semaine du ${currentMonday.toLocaleDateString("fr-FR")} au ${endOfWeek.toLocaleDateString("fr-FR")}`;

  // Construction colonnes jour
  weekGrid.innerHTML = "";
  const days = [];
  for (let i=0; i<7; i++) {
    const d = new Date(currentMonday);
    d.setDate(currentMonday.getDate() + i);
    days.push(d);

    const ymd = d.toISOString().slice(0,10);
    const col = document.createElement("div");
    col.className = "day-column";
    col.dataset.date = ymd;

    const header = document.createElement("div");
    header.className = "day-header";
    header.innerHTML = `<strong>${d.toLocaleDateString("fr-FR", { weekday:"short" })}</strong>${d.toLocaleDateString("fr-FR", { day:"2-digit", month:"2-digit" })}`;
    col.appendChild(header);

    const body = document.createElement("div");
    body.className = "day-body";
    body.dataset.date = ymd;

    // drag-over visuel
    body.ondragover = e => { e.preventDefault(); body.classList.add("drag-over"); };
    body.ondragleave = () => body.classList.remove("drag-over");
    body.ondrop = e => onDropEvent(e, ymd, body);

    col.appendChild(body);
    weekGrid.appendChild(col);
  }

  // Injection interventions dans les bons jours
  filteredEvents.forEach(ev => {
    const { date, time, tech, note } = ev.intervention;
    const container = weekGrid.querySelector(`.day-body[data-date="${date}"]`);
    if (!container) return; // hors semaine

    const card = document.createElement("div");
    card.className = "event-card";
    card.draggable = true;

    // statut pour couleur de fond today/overdue
    if (date === todayYMD) card.classList.add("today");
    else if (date < todayYMD) card.classList.add("overdue");

    const typeColor = colorMap[ev.work] || "#7f8c8d";

    card.innerHTML = `
      <div class="event-bar" style="background:${typeColor}"></div>
      <div class="event-content">
        <div class="event-title">${ev.lastname} ${ev.firstname}</div>
        <div class="event-meta">
          ${time || "—"} ${tech ? " • " + tech : ""}<br>
          <span>${ev.work}</span>
        </div>
      </div>
    `;

    card.dataset.clientId = ev.clientId;

    card.ondragstart = e => {
      e.dataTransfer.setData("clientId", ev.clientId);
      e.dataTransfer.setData("fromDate", date);
    };

    card.onclick = () => openClientInBoard(ev.clientId);

    container.appendChild(card);
  });

  // Liste triée
  const sorted = [...filteredEvents].sort((a,b) => {
    const da = (a.intervention.date || "") + " " + (a.intervention.time || "");
    const db = (b.intervention.date || "") + " " + (b.intervention.time || "");
    return da.localeCompare(db);
  });

  listContainer.innerHTML = "";
  sorted.forEach(ev => {
    const { date, time, tech, note } = ev.intervention;
    const row = document.createElement("div");
    row.className = "list-item";

    let badgeHtml = "";
    if (date === todayYMD) badgeHtml = `<span class="badge badge-today">Aujourd'hui</span>`;
    else if (date < todayYMD) badgeHtml = `<span class="badge badge-overdue">Retard</span>`;

    row.innerHTML = `
      <div class="list-date">${date || "Sans date"} ${badgeHtml}</div>
      <div><strong>${ev.lastname} ${ev.firstname}</strong> – ${ev.work}</div>
      <div>${time || "Horaire à définir"} ${tech ? "• " + tech : ""}</div>
      ${note ? `<div style="font-size:12px;color:#555;">${note}</div>` : ""}
    `;

    listContainer.appendChild(row);
  });
}

/* =============================
   Drag & drop dans le planning
============================= */

function onDropEvent(e, newDate, bodyEl) {
  e.preventDefault();
  bodyEl.classList.remove("drag-over");
  const clientId = e.dataTransfer.getData("clientId");
  const fromDate = e.dataTransfer.getData("fromDate");

  if (!clientId || !newDate || newDate === fromDate) return;

  // retrouver le client dans boardData
  boardData.columns.forEach(col => {
    col.cards.forEach(client => {
      if (client.id === clientId && client.intervention) {
        client.intervention.date = newDate;
        client.history = client.history || [];
        client.history.push({
          action: "Intervention mise à jour",
          date: new Date().toLocaleString()
        });
      }
    });
  });

  localStorage.setItem("boardData", JSON.stringify(boardData));
  renderPlanning();
}

/* =============================
   Lien vers fiche client (board)
============================= */

function openClientInBoard(clientId) {
  // On stocke un ID dans localStorage, le board pourrait s'en servir
  localStorage.setItem("openClientId", clientId);
  window.location.href = "board.html";
}

/* =============================
   INIT
============================= */

currentMonday = getMondayOf(new Date());
renderPlanning();
</script>

</body>
</html>
